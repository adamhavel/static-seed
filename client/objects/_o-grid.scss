/* ==========================================================================
   Grid
   ========================================================================== */

/* Settings
   ========================================================================== */

$GRID_COLUMNS: (
   '>=layout': 3,
   'inbetween': 2,
   '<column': 1
);
$GRID_HGAP: $GUTTER * 2;
$GRID_VGAP: lines(3);


/* Classes
   ========================================================================== */

.o-grid, %o-grid {
   @include island($GRID_VGAP / lines(1) * 1);

   display: flex;
   flex-wrap: wrap;
   justify-content: center;
   margin-left: -$GRID_HGAP;

   &__item {
      margin-left: $GRID_HGAP;
      margin-top: $GRID_VGAP;

      @each $breakpoint, $columns in $GRID_COLUMNS {
         $width: (100% / $columns) - $GRID_HGAP;

         @include media($breakpoint) {
            &:nth-child(-n + #{$columns}) {
               margin-top: 0;
            }
         }

         @if $breakpoint == $MEDIA_STATIC_BREAKPOINT {
            width: $width;
         } @else {
            @include media($breakpoint) {
               width: $width;
            }
         }

      }

   }

   .no-flexbox & {
      display: block;
      letter-spacing: -0.31em;

      &__item {
         display: inline-block;
         letter-spacing: normal;
         vertical-align: top;
      }
   }
}

@mixin grid($items-per-row: $GRID_COLUMNS, $hgap: $GRID_HGAP, $vgap: $GRID_VGAP) {
   @extend %o-grid;

   $items-per-row: map-merge($GRID_COLUMNS, $items-per-row);
   $ie8-friendly: true;

   @if ($hgap != 0) and (unit($hgap) != "%") {
      $ie8-friendly: false;
   }

   @if $vgap != $GRID_VGAP {
      @include island($vgap / lines(1) * 1);
   }

   @if $hgap != $GRID_HGAP {
      @if $ie8-friendly {
         margin-left: -$hgap;
         > * {
            margin-left: $hgap;
         }
      } @else {
         @include gtIE8 {
            margin-left: -$hgap;
            > * {
               margin-left: $hgap;
            }
         }
      }
   }

   > * {
      @extend %o-grid__item;

      $is-default: ($GRID_COLUMNS == $items-per-row) and ($hgap == $GRID_HGAP);

      @if ($vgap != $GRID_VGAP) {
         margin-top: $vgap;
      }

      @each $breakpoint, $columns in $items-per-row {

         @if not $is-default {
            $width: if($ie8-friendly, (100% / $columns) - $hgap, calc(#{(100% / $columns)} - #{$hgap}));

            margin-top: $vgap !important;

            @include media($breakpoint) {
               &:nth-child(-n + #{$columns}) {
                  margin-top: 0 !important;
               }
            }

            @if $breakpoint == $MEDIA_STATIC_BREAKPOINT {

               @if $ie8-friendly {
                  width: $width;
               } @else {
                  width: (100% / $columns) - $GRID_HGAP;
                  width: $width;
               }

            } @else {

               @include media($breakpoint) {
                  width: $width;
               }

            }

         }

      }

   }

}