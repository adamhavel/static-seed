/* ==========================================================================
   Grid
   ========================================================================== */

/* Settings
   ========================================================================== */

$grid-columns: (
   '>=layout': 3,
   'inbetween': 2,
   '<column': 1
);
$grid-hgap: const(GUTTER);
$grid-vgap: lines(1);


/* Classes
   ========================================================================== */

.o-grid,
%o-grid {
   display: flex;
   flex-wrap: wrap;
   margin-left: -$grid-hgap;
   justify-content: center;

   .no-flexbox & {
      display: block;
      letter-spacing: -.31em;
   }
}

   .o-grid__item,
   %o-grid__item {
      margin-left: $grid-hgap;
      margin-top: $grid-vgap;

      @each $breakpoint, $columns in $grid-columns {
         $width: (100% / $columns) - $grid-hgap;

         @include media($breakpoint) {
            &:nth-child(-n + #{$columns}) {
               margin-top: 0;
            }
         }

         @if $breakpoint == $media-static-breakpoint {
            width: $width;
         } @else {
            @include media($breakpoint) {
               width: $width;
            }
         }

      }

      .no-flexbox & {
         display: inline-block;
         letter-spacing: normal;
         vertical-align: top;
      }
   }

@mixin grid($items-per-row: $grid-columns, $hgap: $grid-hgap, $vgap: $grid-vgap) {
   @extend %o-grid;

   $items-per-row: map-merge($grid-columns, $items-per-row);
   $ie8-friendly: true;

   @if ($hgap != 0) and (unit($hgap) != '%') {
      $ie8-friendly: false;
   }

   @if $vgap != $grid-vgap {
      @include island($vgap / lines(1) * 1);
   }

   @if $hgap != $grid-hgap {
      @if $ie8-friendly {
         margin-left: -$hgap;

         > * {
            margin-left: $hgap;
         }
      } @else {
         @include gt-ie8 {
            margin-left: -$hgap;

            > * {
               margin-left: $hgap;
            }
         }
      }
   }

   > * {
      @extend %o-grid__item;

      $is-default: ($grid-columns == $items-per-row) and ($hgap == $grid-hgap);

      @if ($vgap != $grid-vgap) {
         margin-top: $vgap;
      }

      @each $breakpoint, $columns in $items-per-row {

         @if not $is-default {
            $width: if($ie8-friendly, (100% / $columns) - $hgap, calc(#{(100% / $columns)} - #{$hgap}));

            margin-top: $vgap;// !important;

            @include media($breakpoint) {
               &:nth-child(-n + #{$columns}) {
                  margin-top: 0;// !important;
               }
            }

            @if $breakpoint == $media-static-breakpoint {

               @if $ie8-friendly {
                  width: $width;
               } @else {
                  width: (100% / $columns) - $grid-hgap;
                  width: $width;
               }

            } @else {

               @include media($breakpoint) {
                  width: $width;
               }

            }

         }

      }

   }

}
